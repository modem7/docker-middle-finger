---

kind: pipeline
type: docker
name: latest

platform:
  os: linux
  arch: amd64

steps:
  - name: Lint Dockerfile
    image: hadolint/hadolint:latest-alpine
    pull: if-not-exists
    commands:
      - hadolint --version
      - hadolint */Dockerfile

  - name: single  
    image: thegeeklab/drone-docker-buildx
    privileged: true
    settings:
      repo: modem7/middle-finger # Dockerhub repo
      purge: true
      compress: true
      use_cache: true
      dockerfile: single/Dockerfile
      cache_from: "modem7/middle-finger:latest"
      platforms: # if it doesn't work run docker run --privileged --rm tonistiigi/binfmt --install all
        - linux/amd64
        - linux/arm/v6
        - linux/arm/v7
        - linux/arm64/v8
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      tags: latest

  - name: dual  
    image: thegeeklab/drone-docker-buildx
    privileged: true
    settings:
      repo: modem7/middle-finger # Dockerhub repo
      purge: true
      compress: true
      use_cache: true
      dockerfile: dual/Dockerfile
      cache_from: "modem7/middle-finger:dual"
      platforms: # if it doesn't work run docker run --privileged --rm tonistiigi/binfmt --install all
        - linux/amd64
        - linux/arm/v6
        - linux/arm/v7
        - linux/arm64/v8
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      tags: dual

  - name: slack
    image: themaz/drone-slack
    settings:
      webhook:
        from_secret: slack_hook
    when:
      status: [ success, failure ]

trigger:
  event:
    - custom